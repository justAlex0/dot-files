#!/usr/bin/env bash

[[ -z "$DEBUG" ]] && DEBUG=false
$DEBUG && set -Eeuxo pipefail

# if [[ $(loginctl show-session self -p Type | awk -F "=" '/Type/ {print $NF}') != "wayland" ]]; then
if [[ -n "$WAYLAND_DISPLAY" ]]; then
    (exec bwrap \
        --ro-bind /usr/share /usr/share/ \
        --ro-bind /usr/lib /usr/lib \
        --ro-bind /usr/lib64 /usr/lib64 \
        --symlink /usr/lib64 /lib64 \
        --symlink /usr/lib /lib \
        --symlink /usr/bin /bin \
        --symlink /usr/bin /sbin \
        --proc /proc \
        --dev /dev \
        --dev-bind /dev/snd /dev/snd \
        --dev-bind /dev/char /dev/char \
        --ro-bind /sys/class/hidraw /sys/class/hidraw \
        --ro-bind /sys/devices/pci0000:00 /sys/devices/pci0000:00 \
        --ro-bind /etc/resolv.conf /etc/resolv.conf \
        --ro-bind /etc/fonts /etc/fonts \
        --ro-bind /usr/share/ca-certificates /usr/share/ca-certificates \
        --ro-bind /etc/ssl /etc/ssl \
        --ro-bind /etc/ca-certificates /etc/ca-certificates \
        --ro-bind-try /etc/alsa /etc/alsa \
        --ro-bind-try /etc/pulse /etc/pulse \
        --ro-bind-try /etc/pipewire /etc/pipewire \
        --tmpfs /run \
        --ro-bind-try /run/user/"$(id -u)"/pipewire-0 /run/user/"$(id -u)"/pipewire-0 \
        --ro-bind /run/user/"$(id -u)/$WAYLAND_DISPLAY" /run/user/"$(id -u)/$WAYLAND_DISPLAY" \
        --bind ~/.librewolf ~/.librewolf \
        --bind ~/Downloads ~/Downloads \
        --unsetenv DBUS_SESSION_BUS_ADDRESS \
        --setenv MOZ_ENABLE_WAYLAND 1 \
        --setenv GTK_THEME Catppuccin-Mocha-Red \
        --hostname firefox \
        --unshare-all \
        --share-net \
        --die-with-parent \
        --new-session \
        /usr/lib/librewolf/librewolf)

else
    /usr/lib/librewolf/librewolf
fi
